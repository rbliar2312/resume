<script>
        // === ИНТЕГРАЦИЯ С GOOGLE SHEETS ===
        const SHEETS_URLS = {
            project: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSV5Z3aWm3z0DtdVA9vviQ3hsE_RKm7uEaysK53Dgd8ExJ2aUdrGX6xmkHFHYejISw7vtroWX1g-yiM/pub?gid=0&single=true&output=csv',
            status: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSV5Z3aWm3z0DtdVA9vviQ3hsE_RKm7uEaysK53Dgd8ExJ2aUdrGX6xmkHFHYejISw7vtroWX1g-yiM/pub?gid=609284929&single=true&output=csv',
            roadmap: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSV5Z3aWm3z0DtdVA9vviQ3hsE_RKm7uEaysK53Dgd8ExJ2aUdrGX6xmkHFHYejISw7vtroWX1g-yiM/pub?gid=870835068&single=true&output=csv'
        };

        let projectData = [];
        let statusData = [];
        let roadmapData = [];
        let currentProjectName = null;
        
        // --- ПАРСЕР CSV ---
        function parseCSV(text) {
            const lines = text.trim().split(/\r?\n/);
            const headers = lines[0].split(',');
            return lines.slice(1).map(line => {
                // Более надежный сплит, который учитывает запятые внутри кавычек (хотя Google Sheets обычно их не ставит в CSV)
                const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                return headers.reduce((obj, header, index) => {
                    obj[header.trim()] = values[index] ? values[index].trim().replace(/^"|"$/g, '') : '';
                    return obj;
                }, {});
            }).filter(obj => obj.Проект); // Фильтруем строки, где колонка "Проект" пустая!
        }

        // --- ГЛАВНЫЕ ФУНКЦИИ РЕНДЕРИНГА ---
        function renderHomePage() { /* ... */ }
        function renderProjectPage(projectName) { /* ... */ }
        
        // --- ФУНКЦИИ РЕНДЕРИНГА ОТДЕЛЬНЫХ СТРАНИЦ ПРОЕКТА ---
        function renderDescriptionView(projectName) {
            const project = projectData.find(p => p['Проект'] === projectName);
            const container = document.getElementById('content-description');
            container.innerHTML = `
                <div class="description-layout">
                    <div class="desc-column">
                        <div class="desc-card full-height">
                            <h3>ОПИСАНИЕ ПРОЕКТА</h3>
                            <p>${project['Описание проекта'] || 'Нет данных'}</p>
                        </div>
                    </div>
                    <div class="desc-column">
                        <div class="desc-card">
                            <h3>УЧАСТНИКИ</h3>
                            <p>${(project['Участники'] || 'Нет данных').replace(/;/g, '<br>')}</p>
                        </div>
                        <a href="${project['Страница в конфлюс']}" target="_blank" class="confluence-button">ССЫЛКА НА CONFLUENCE</a>
                    </div>
                </div>
            `;
        }
        
        function renderStatusView(projectName) {
            const projectStatus = statusData.find(item => item['Проект'] === projectName);
            const container = document.getElementById('content-status');
            if (!projectStatus) {
                container.innerHTML = `<p>Данные по статусу для этого проекта отсутствуют.</p>`;
                return;
            }

            const categories = { "ВЫПОЛНЕНО": [], "КЛЮЧЕВЫЕ ЗАДАЧИ": [], "ПЛАН НА 4Q25": [], "РИСКИ": [] };
            
            for (const key in projectStatus) {
                if (!projectStatus[key]) continue; 
                if (key.startsWith('Выполнено')) categories['ВЫПОЛНЕНО'].push({ num: key.replace('Выполнено', ''), text: projectStatus[key] });
                else if (key.startsWith('КЗ')) categories['КЛЮЧЕВЫЕ ЗАДАЧИ'].push({ num: key.replace('КЗ', ''), text: projectStatus[key] });
                else if (key.startsWith('План')) categories['ПЛАН НА 4Q25'].push({ num: key.replace('План', ''), text: projectStatus[key] });
                else if (key.startsWith('Риски')) {
                    const riskNum = key.replace('Риски', '');
                    categories['РИСКИ'].push({ text: projectStatus[key], comment: projectStatus[`Комент риски${riskNum}`] || '' });
                }
            }

            container.innerHTML = `<div class="status-grid">
                <div class="status-card">
                    <div class="status-card-header green">ВЫПОЛНЕНО</div>
                    <div class="status-item-grid">${categories['ВЫПОЛНЕНО'].map(item => `<div class="status-item-tile"><div class="status-item-num">${item.num}</div><div class="status-item-text">${item.text}</div></div>`).join('')}</div>
                </div>
                <div class="status-card">
                    <div class="status-card-header red">РИСКИ</div>
                    ${categories['РИСКИ'].map(item => `<div class="status-risk-item">${item.text}<div class="status-risk-comment">${item.comment}</div></div>`).join('')}
                </div>
                <div class="status-card">
                    <div class="status-card-header blue">КЛЮЧЕВЫЕ ЗАДАЧИ</div>
                    <div class="status-item-grid">${categories['КЛЮЧЕВЫЕ ЗАДАЧИ'].map(item => `<div class="status-item-tile"><div class="status-item-num">${item.num}</div><div class="status-item-text">${item.text}</div></div>`).join('')}</div>
                </div>
                <div class="status-card">
                    <div class="status-card-header blue">ПЛАН НА 4Q25</div>
                    <div class="status-item-grid">${categories['ПЛАН НА 4Q25'].map(item => `<div class="status-item-tile"><div class="status-item-num">${item.num}</div><div class="status-item-text">${item.text}</div></div>`).join('')}</div>
                </div>
            </div>`;
        }

        function renderRoadmapView(projectName) {
            const data = roadmapData.filter(item => item['Проект'] === projectName);
            const container = document.getElementById('content-roadmap');
            container.innerHTML = `<p>Отображение нового формата роадмапа в разработке...</p>`;
        }
        
        function renderTenderView(projectName) { /* ... */ }

        // --- ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ И ИНИЦИАЛИЗАЦИЯ ---
        function showPage(pageId) { /* ... */ }
        function switchProjectView(viewId, renderFunc) { /* ... */ }
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Инициализация. Загрузка данных...');
            document.getElementById('back-to-home').onclick = renderHomePage;
            
            // --- *** ВОТ ОНО, ИЗМЕНЕНИЕ *** ---
            const cacheBuster = `&v=${new Date().getTime()}`;

            Promise.all([
                fetch(SHEETS_URLS.project + cacheBuster).then(res => res.text()),
                fetch(SHEETS_URLS.status + cacheBuster).then(res => res.text()),
                fetch(SHEETS_URLS.roadmap + cacheBuster).then(res => res.text())
            ]).then(([projectCSV, statusCSV, roadmapCSV]) => {
                projectData = parseCSV(projectCSV);
                statusData = parseCSV(statusCSV);
                roadmapData = parseCSV(roadmapCSV);
                console.log('Данные успешно загружены и обработаны.', { projectData, statusData, roadmapData });
                renderHomePage();
            }).catch(error => {
                console.error("Критическая ошибка при загрузке данных из Google Sheets:", error);
                document.body.innerHTML = '<h1>Ошибка загрузки данных. Проверьте консоль (F12) и доступ к таблицам.</h1>';
            });
        });
        
        function renderHomePage() { const container = document.getElementById('project-list'); container.innerHTML = ''; projectData.forEach(p => { const button = document.createElement('button'); button.className = 'project-button'; button.textContent = p['Проект']; button.onclick = () => renderProjectPage(p['Проект']); container.appendChild(button); }); showPage('page-home'); }
        function renderProjectPage(projectName) { currentProjectName = projectName; const project = projectData.find(p => p['Проект'] === projectName); if (!project) return; document.getElementById('project-header-name').textContent = project['Проект']; const navContainer = document.getElementById('project-navigation'); navContainer.innerHTML = ''; const navs = { 'Описание': { id: 'content-description', exists: true, renderFunc: renderDescriptionView }, 'Статус': { id: 'content-status', exists: project['Статус'] === '1', renderFunc: renderStatusView }, 'Роадмап': { id: 'content-roadmap', exists: project['Роадмап'] === '1', renderFunc: renderRoadmapView }, 'Тендер': { id: 'content-tender', exists: project['Участники тендера'] === '1', renderFunc: renderTenderView } }; for (const navName in navs) { if (navs[navName].exists) { const button = document.createElement('button'); button.textContent = navName; button.className = 'nav-button'; button.dataset.view = navs[navName].id; button.onclick = () => switchProjectView(navs[navName].id, navs[navName].renderFunc); navContainer.appendChild(button); } } showPage('page-project'); switchProjectView(navs['Описание'].id, navs['Описание'].renderFunc); }
        function renderTenderView(projectName) { const container = document.getElementById('content-tender'); container.innerHTML = `<p>Структура для страницы 'Тендер' будет определена позже.</p>`; }
        function showPage(pageId) { document.getElementById('page-home').classList.add('hidden'); document.getElementById('page-project').classList.add('hidden'); document.getElementById(pageId).classList.remove('hidden'); }
        function switchProjectView(viewId, renderFunc) { document.querySelectorAll('.project-view').forEach(view => view.classList.add('hidden')); const viewContainer = document.getElementById(viewId); viewContainer.classList.remove('hidden'); renderFunc(currentProjectName); document.querySelectorAll('.nav-button').forEach(button => button.classList.remove('active')); document.querySelector(`.nav-button[data-view="${viewId}"]`).classList.add('active'); const titles = { 'content-description': 'ОПИСАНИЕ ПРОЕКТА', 'content-status': 'СТАТУС ПО ПРОЕКТУ', 'content-roadmap': 'ROADMAP ПРОЕКТА', 'content-tender': 'ТЕНДЕР' }; document.getElementById('project-header-title').textContent = titles[viewId]; }
    </script>
